name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Detect which paths changed to conditionally run jobs
  # ─────────────────────────────────────────────────────────────────────────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      host: ${{ steps.filter.outputs.host }}
      guest: ${{ steps.filter.outputs.guest }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            host:
              - 'host/**'
              - 'shared/**'
              - '.github/workflows/ci.yml'
              - '.github/Brewfile.host-*'
            guest:
              - 'guest/**'
              - 'shared/**'
              - '.github/workflows/ci.yml'

  # ─────────────────────────────────────────────────────────────────────────────
  # Host (macOS) - Lint + Build + Test in single job to avoid runner overhead
  # macOS runners are 10x more expensive than Linux, so minimize job count
  # ─────────────────────────────────────────────────────────────────────────────
  host:
    name: Host (Lint + Build + Test)
    needs: changes
    if: needs.changes.outputs.host == 'true'
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      # Cache Homebrew Cellar only - contains packages + receipts
      # brew bundle will relink on restore (fast) instead of reinstalling (slow)
      - name: Cache Homebrew Cellar
        id: brew-cache
        uses: actions/cache@v4
        with:
          path: /opt/homebrew/Cellar
          key: brew-cellar-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('.github/Brewfile.host-build', '.github/Brewfile.host-lint') }}

      - name: Install dependencies
        timeout-minutes: 10
        env:
          HOMEBREW_NO_AUTO_UPDATE: 1        # Skip formula updates (biggest win)
          HOMEBREW_NO_INSTALL_CLEANUP: 1    # Skip cleanup after install
          HOMEBREW_NO_INSTALLED_DEPENDENTS_CHECK: 1  # Skip upgrade checks
        run: |
          # On cache hit: packages exist in Cellar, brew just relinks (~10-30s)
          # On cache miss: full install, then cache is saved for next run
          brew bundle install --file=.github/Brewfile.host-lint --no-upgrade --verbose
          brew bundle install --file=.github/Brewfile.host-build --no-upgrade --verbose
          # Verify tools are available
          swiftlint version
          pkg-config --modversion spice-client-glib-2.0

      # Lint first (fast, catches issues early)
      - name: Lint (SwiftLint)
        working-directory: host
        run: swiftlint lint --strict --reporter github-actions-logging

      # Cache Swift Package Manager build artifacts
      - name: Cache Swift build
        uses: actions/cache@v4
        with:
          path: |
            host/.build
            host/.swiftpm
            ~/Library/Caches/org.swift.swiftpm
          key: swift-${{ runner.os }}-${{ runner.arch }}-${{ hashFiles('host/Package.swift', 'host/Package.resolved') }}
          restore-keys: swift-${{ runner.os }}-${{ runner.arch }}-

      - name: Validate protocol
        run: make validate-protocol-host

      - name: Build
        working-directory: host
        run: swift build

      - name: Test
        working-directory: host
        run: swift test

  # ─────────────────────────────────────────────────────────────────────────────
  # Guest (Windows) - Lint + Build + Test in single job to avoid runner overhead
  # ─────────────────────────────────────────────────────────────────────────────
  guest:
    name: Guest (Lint + Build + Test)
    needs: changes
    if: needs.changes.outputs.guest == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          global-json-file: guest/global.json

      - name: Restore dependencies
        working-directory: guest
        run: dotnet restore WinRunAgent.sln

      # Lint first (fast, catches formatting issues early)
      # Format only C# projects (not WiX installer which has different file types)
      - name: Lint (dotnet format)
        working-directory: guest
        run: |
          dotnet format WinRunAgent/WinRunAgent.csproj --verify-no-changes
          dotnet format WinRunAgent.Tests/WinRunAgent.Tests.csproj --verify-no-changes

      - name: Validate protocol
        run: make validate-protocol-guest

      - name: Build
        working-directory: guest
        run: dotnet build WinRunAgent.sln --no-restore --configuration Release

      - name: Test
        working-directory: guest
        run: dotnet test WinRunAgent.sln --no-build --configuration Release --verbosity normal

  # ─────────────────────────────────────────────────────────────────────────────
  # Guest MSI Installer - builds after successful guest job
  # ─────────────────────────────────────────────────────────────────────────────
  guest-installer:
    name: Guest MSI Installer
    needs: [changes, guest]
    if: needs.changes.outputs.guest == 'true'
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          global-json-file: guest/global.json

      - name: Restore dependencies
        working-directory: guest
        run: dotnet restore WinRunAgent.sln

      - name: Build MSI Installer
        run: |
          .\scripts\build-guest-installer.ps1 -Configuration Release -OutputDir .\artifacts

      - name: Upload MSI Artifact
        uses: actions/upload-artifact@v4
        with:
          name: WinRunAgent-Installer
          path: artifacts/
          retention-days: 30
          if-no-files-found: error

  # ─────────────────────────────────────────────────────────────────────────────
  # Final gate - require this single check in branch protection
  # Jobs are successful if they passed OR were skipped (no relevant changes)
  # ─────────────────────────────────────────────────────────────────────────────
  ci:
    name: CI
    runs-on: ubuntu-latest
    if: always()
    needs: [changes, host, guest, guest-installer]
    steps:
      - name: Check all jobs passed
        run: |
          echo "Job results:"
          echo "  changes:        ${{ needs.changes.result }}"
          echo "  host:           ${{ needs.host.result }}"
          echo "  guest:          ${{ needs.guest.result }}"
          echo "  guest-installer: ${{ needs.guest-installer.result }}"
          echo ""
          
          # A job is OK if it succeeded or was skipped (no relevant files changed)
          check_job() {
            local result="$1"
            local name="$2"
            if [[ "$result" != "success" && "$result" != "skipped" ]]; then
              echo "❌ $name failed (status: $result)"
              return 1
            fi
            return 0
          }
          
          failed=0
          check_job "${{ needs.changes.result }}" "changes" || failed=1
          check_job "${{ needs.host.result }}" "host" || failed=1
          check_job "${{ needs.guest.result }}" "guest" || failed=1
          check_job "${{ needs.guest-installer.result }}" "guest-installer" || failed=1
          
          if [[ $failed -eq 1 ]]; then
            echo ""
            echo "❌ One or more jobs failed"
            exit 1
          fi
          
          echo "✅ All CI checks passed!"
